<!-- Meta tags -->
<!-- Basic meta tags -->
<update-title title="{{ vm.title }}"></update-title>
<update-meta name="description" content="{{ vm.desc }}"></update-meta>

<!-- Facebook META -->
<update-meta property="og:title" content="{{ vm.title }}"></update-meta>
<update-meta property="og:description" content="{{ vm.desc }}"></update-meta>
<update-meta property="og:url" use-abs-url="true"></update-meta>
<update-meta property="og:image" content="{{ vm.image }}"></update-meta>

<!-- Twitter META -->
<update-meta name="twitter:title" content="{{ vm.title }}"></update-meta>
<update-meta name="twitter:description" content="{{ vm.desc }}"></update-meta>
<update-meta name="twitter:url" use-abs-url="true"></update-meta>
<update-meta name="twitter:image" content="{{ vm.image }}"></update-meta>

<md-toolbar class="md-primary">
	<div flex-offset-lg="15" flex-lg="70" flex-offset-xl="25" flex-xl="50" layout="column" layout-padding>
		<div layout-gt-sm="row" layout="column" layout-align="start start" layout-align-gt-sm="center center">
			<h1 class="md-display-1" flex-gt-sm="65">{{vm.goal.title}}</h1>

			<div flex></div>

			<div layout="row" layout-align="center center">
				<div ng-if="authentication.user.roles.indexOf('admin')>-1 || (authentication.user.roles != null && authentication.user._id===vm.issue.user._id)">
					<md-button class="md-icon-button" ng-click="vm.delete()">
						<md-tooltip>Delete Goal</md-tooltip>
						<md-icon>delete</md-icon>
					</md-button>
					<md-button class="md-icon-button" ui-sref="goals.edit({goalId: vm.goal._id})">
						<md-tooltip>Edit Goal</md-tooltip>
						<md-icon>edit</md-icon>
					</md-button>
				</div>

				<md-button ng-if="authentication.user.roles.indexOf('admin')>-1" class="md-accent md-hue-1 md-raised create-btn" ui-sref="solutions.create({goalId: vm.goal._id})">
					<md-icon>add</md-icon><span hide show-gt-sm>New</span>
					<md-tooltip>Create a new solution</md-tooltip>
				</md-button>
				<md-button ng-hide="authentication.user.roles.indexOf('admin')==1" class="md-accent md-hue-1 md-raised create-btn" ui-sref="suggestions">
					<md-icon>add</md-icon><span hide show-gt-sm>New</span>
					<md-tooltip>Suggest a new solution</md-tooltip>
				</md-button>
			</div>
		</div>

		<div class="header-image-container" flex>
			<img ng-src="{{::vm.goal.imageUrl}}" alt="Goal Image">
		</div>

		<span class="md-body-1">Related Issues:
			<a layout-margin ng-repeat="issue in vm.goal.issues" ui-sref="issues.view({issueId: issue._id})">{{issue.name}}</a>
		</span>

		<div class="header-description" ng-class="{full: vm.showFullDesc}" ng-bind-html="vm.goal.description"></div>

		<div layout="row">
			<div layout="column" ng-if="vm.goal.tags.length > 0">
				<md-chips class="descriptionChips" ng-model="vm.goal.tags" readonly="true" md-removable="false">
				</md-chips>
			</div>

			<div flex></div>

			<md-button  ng-click="vm.showFullDesc=!vm.showFullDesc">
				<span ng-if="vm.showFullDesc">Show Less</span>
				<span ng-if="!vm.showFullDesc">...Show More</span>
			</md-button>
		</div>

		<div layout="column" layout-gt-sm="row" layout-align="start start" layout-align-gt-sm="start center">

			<div layout="row">
				<md-button class="md-raised vote-btn" ng-class="{ selected: vm.goal.votes.currentUser.voteValue===1 }" ng-click="vm.vote('up')">
					<md-icon>arrow_upward</md-icon> Vote Up
					<md-tooltip ng-if="vm.goal.votes.currentUser.voteValue===1">Undo</md-tooltip>
				</md-button>
				<div class="chart-container">
					<div class="chart-score">
						<span>{{vm.goal.votes.up - vm.goal.votes.down}}</span>
					</div>
					<vote-details object="vm.goal"></vote-details>
				</div>
				<!-- <md-button class="md-fab md-primary md-hue-2 vote-score" ng-class="" ng-click="">
					<md-tooltip>
						<span>For: {{vm.goal.votes.up}}, Against: {{vm.goal.votes.down}}</span>
					</md-tooltip>
					{{vm.goal.votes.up - vm.goal.votes.down}}
				</md-button> -->
				<md-button class="md-raised vote-btn" ng-class="{ selected: vm.goal.votes.currentUser.voteValue===-1 }" ng-click="vm.vote('down')">
					<md-icon>arrow_downward</md-icon>Vote Down
					<md-tooltip ng-if="vm.goal.votes.currentUser.voteValue===-1">Undo</md-tooltip>
				</md-button>
			</div>

			<div layout="row">
				<share-buttons object="vm.goal" object-type="'goal'" vertical-resize="false"></share-buttons>
			</div>
		</div>
	</div>
	<div layout="row" layout-padding md-colors="{background: 'orange'}" ng-if="vm.isSingleSolution" ui-sref="goals.view({goalId: '{{vm.goal._id}}'})">
		<span flex-offset-lg="15" flex-lg="70" flex-offset-xl="25" flex-xl="50">You are viewing a single solution, click here to view all solutions for this goal.</span>
	</div>
</md-toolbar>

<div flex-offset-lg="15" flex-lg="70" flex-offset-xl="25" flex-xl="50">
	<md-tabs md-dynamic-height md-border-bottom>
		<md-tab label="solutions">

			<div layout-gt-sm="row" layout-align-gt-sm="start center" layout-padding>
				<span>Sort</span>
				<div>
					<md-select class="sort-select" ng-model="vm.sortSelectState" md-on-close='vm.sort(vm.sortSelectState)'>
						<md-option ng-value="{type: 'top', order: 'desc'}" ng-selected=true>Top</md-option>
						<md-option ng-value="{type: 'controversial', order: 'desc'}">Controversial</md-option>
						<md-option ng-value="{type: 'trending', order: 'desc'}">Trending</md-option>
						<md-option ng-value="{type: 'newest', order: 'desc'}">Newest</md-option>
					</md-select>

					<md-tooltip ng-if="vm.sortSelectState.type === 'top'">Total score of votes</md-tooltip>
					<md-tooltip ng-if="vm.sortSelectState.type === 'controversial'">Greatest difference in opinion</md-tooltip>
					<md-tooltip ng-if="vm.sortSelectState.type === 'trending'">Recently popular</md-tooltip>
					<md-tooltip ng-if="vm.sortSelectState.type === 'newest'">Most recently updated or created</md-tooltip>
				</div>
				<div flex>

				</div>
				<span>Filter</span>
				<div layout-align="start center">

					<md-chips ng-model="vm.regions" md-require-match="true" md-on-add="vm.updateVotes(vm.regions)" md-on-remove="vm.updateVotes(vm.regions)" md-delay="400" placeholder="All regions" secondary-placeholder="Add another region">
						<md-chip-template>
							<span>{{ $chip.name }}</span>
						</md-chip-template>
						<md-autocomplete md-no-cache="true" md-items="region in vm.searchRegions(regionName)" md-dropdown-items="5" md-search-text="regionName" placeholder="Add regions" md-item-text="region.name">
							<md-item-template>
								<span md-highlight-text="regionName" md-highlight-flags="i">
							  {{ region.name }} ({{region.type}})
						  </span>
							</md-item-template>
							<md-not-found>
								No regions found.
							</md-not-found>
						</md-autocomplete>
					</md-chips>
				</div>
			</div>

			<div layout="column" layout-padding ng-if="vm.creatingSolution">
				<md-input-container class="md-block compact">
					<label>Solution Summary</label>
					<input ng-model="vm.newSolution.title" autofocus md-placeholder="">
				</md-input-container>
				<!--
				<md-input-container class="md-block">
				<label>Solution Details</label>
				<textarea ng-model="vm.newSolution.description"></textarea>
			</md-input-container> -->

				<div layout="row">
					<md-button class="md-primary md-raised" ng-click="vm.createSolution()">
						Submit
					</md-button>
					<md-button class="md-warn md-raised" ng-click="vm.showCreateSolution()">
						Cancel
					</md-button>
				</div>
			</div>


			<div layout-padding>
				<md-card class="solution-card" md-rowspan="3" md-colspan="2" md-colspan-sm="1" md-colspan-xs="1" ng-if="vm.solutions.length==0">
					<md-card-title>
						<md-card-title-text>
							<span class="md-headline">Looks like there are no proposed solutions yet, suggest one!</span>
							<!-- <span class="md-subhead">{{::solution.description}}</span> -->
						</md-card-title-text>
					</md-card-title>
				</md-card>
				<md-card class="solution-card" ng-repeat="solution in vm.solutions | orderBy: vm.sortSvc.expression: vm.sortSvc.reverse">
					<md-card-header>
						<md-card-avatar>
							<img ng-src="{{::solution.imageUrl}}" alt="Solution Image" />
						</md-card-avatar>
						<md-card-header-text>
							<span class="md-headline">{{::solution.title}}</span>
							<span class="md-subhead" ng-bind="solution.description | htmlToPlaintext"></span>
						</md-card-header-text>
					</md-card-header>
					<md-card-actions layout="row" layout-align="start start">
						<md-card-icon-actions>
							<md-button class="md-icon-button vote-btn" ng-class="{ selected: solution.votes.currentUser.voteValue===1 }" ng-click="vm.voteSolution(solution, 'up', $event)">
								<md-tooltip>
									<span ng-if="solution.votes.currentUser.voteValue===1">Undo</span>
									<span ng-if="solution.votes.currentUser.voteValue!==1">Vote Up</span>
								</md-tooltip>
								<md-icon>arrow_upward</md-icon>
							</md-button>
							<!-- up: {{solution.votes.up}}, down: {{solution.votes.down}}, total: {{solution.votes.total}}, currentUser: {{solution.votes.currentUser.voteValue}}, score:  {{solution.votes.up - solution.votes.down + solution.votes.currentUser.voteValue}} -->
							<!-- <md-button class="md-icon-button" ng-class="" ng-click="">
								<md-tooltip>
									<span>For: {{solution.votes.up}}, Against: {{solution.votes.down}}</span>
								</md-tooltip>
								{{solution.votes.up - solution.votes.down}}
							</md-button> -->
							<div class="card-chart-container">
								<div class="card-chart-score">
									<span>{{solution.votes.up - solution.votes.down}}</span>
								</div>
								<canvas id="card-pie"
									class="chart chart-pie"
									chart-data="[solution.votes.down, solution.votes.up]"
									chart-labels="vm.chartLabels"
									chart-options="vm.chartOptions"
									chart-colors="vm.chartColors"
									height="100%" width="100%">
								</canvas>
								<md-tooltip>
									<span>For: {{solution.votes.up}}, Against: {{solution.votes.down}}</span>
								</md-tooltip>
							</div>
							<md-button class="md-icon-button vote-btn" ng-class="{ selected: solution.votes.currentUser.voteValue===-1 }" ng-click="vm.voteSolution(solution, 'down', $event)">
								<md-tooltip>
									<span ng-if="solution.votes.currentUser.voteValue===-1">Undo</span>
									<span ng-if="solution.votes.currentUser.voteValue!==-1">Vote Down</span>
								</md-tooltip>
								<md-icon>arrow_downward</md-icon>
							</md-button>
							<div ng-if="authentication.user.roles != null && (authentication.user.roles.indexOf('admin') !== -1 || authentication.user._id===solution.user._id)">
								<md-button class="md-icon-button" ng-click="vm.deleteSolution(solution)">
									<md-tooltip>Delete</md-tooltip>
									<md-icon>delete</md-icon>
								</md-button>
								<md-button class="md-icon-button" ui-sref="solutions.edit({solutionId: solution._id, goalId: vm.goal._id})">
									<md-tooltip>Edit Solution</md-tooltip>
									<md-icon>edit</md-icon>
								</md-button>
							</div>

							<div flex>
							  <share-buttons object="solution" req-object="vm.goal" object-type="'solution'" vertical-resize="true"></share-buttons>
							</div>
						</md-card-icon-actions>
					</md-card-actions>
				</md-card>
			</div>
		</md-tab>
		<md-tab label="media">
			<media-list media="vm.media" object-id="vm.goal._id" , object-type="'goal'"></media-list>
		</md-tab>
		<md-tab label="discuss">
			<md-content layout="column" layout-align="center" ng-if="!prerender">
				<div layout-padding>
					<div class="polis" data-topic="What do you think?" data-page_id="{{vm.goal._id}}" data-site_id="polis_site_id_7YYdpN4NRpUvCKC7ZU">
					</div>
				</div>
			</md-content>
		</md-tab>
	</md-tabs>
</div>
